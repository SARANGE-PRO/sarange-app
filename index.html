<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Sarange Pro</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#2563EB">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            slate: { 850: '#1a202c', 950: '#0f172a' },
            brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563EB', 700: '#1d4ed8' }
          },
          animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
          keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
        }
      }
    }
  </script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    input, textarea, select, button { font-size: 16px; touch-action: manipulation; } 
    .no-select { user-select: none; -webkit-user-select: none; }
    .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    .suggestions-list { max-height: 250px; overflow-y: auto; position: absolute; z-index: 50; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); margin-top: 4px; }
    .dark .suggestions-list { background: #1e293b; border-color: #334155; }
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; color: black !important; padding: 0 !important; margin: 0 !important; overflow: visible !important; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-200">
  
  <div id="root">
    <div class="flex flex-col items-center justify-center h-screen text-slate-400">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-brand-600 mb-4"></div>
      <p class="font-medium">Chargement...</p>
    </div>
  </div>

  <script type="text/babel" data-type="module" data-presets="react">
    import React, { useState, useEffect, useRef, useMemo, createContext, useContext, useCallback } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { 
      Plus, Trash2, Save, ArrowLeft, FileText, Check, AlertTriangle, PenTool, X, 
      ChevronDown, ChevronUp, Share, Printer, CheckCircle, Download, Eye, Clock, 
      MessageCircle, MapPin, Copy, Camera, Image as ImageIcon, Moon, Sun, 
      LayoutDashboard, Search, Settings, AlertCircle, Mail, Maximize
    } from 'https://esm.sh/lucide-react@0.263.1';

    // --- UTILS ---
    const generateUUID = () => {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };

    const DB_NAME = 'SarangeDB_V2';
    const DB_VERSION = 1;
    const hasIDB = (typeof window !== 'undefined') && ('indexedDB' in window);
    const dbPromise = hasIDB ? new Promise((resolve, reject) => {
      try {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => { console.warn("IDB Failed"); resolve(null); }; 
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('data')) { db.createObjectStore('data', { keyPath: 'key' }); }
        };
      } catch(e) { resolve(null); }
    }) : Promise.resolve(null);
    const memoryStore = {};
    const Storage = {
      async get(key) {
        const db = await dbPromise;
        if (!db) return memoryStore[key] || null;
        return new Promise((resolve) => {
          try {
            const tx = db.transaction('data', 'readonly');
            const store = tx.objectStore('data');
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result ? req.result.value : null);
            req.onerror = () => resolve(null);
          } catch(e) { resolve(null); }
        });
      },
      async set(key, value) {
        const db = await dbPromise;
        if (!db) { memoryStore[key] = value; return; }
        return new Promise((resolve) => {
          try {
            const tx = db.transaction('data', 'readwrite');
            const store = tx.objectStore('data');
            const req = store.put({ key, value });
            req.onsuccess = () => resolve();
            req.onerror = () => resolve();
          } catch(e) { resolve(); }
        });
      }
    };

    const compressImage = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (ev) => {
                const img = new Image();
                img.src = ev.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 1200; 
                    const scale = Math.min(1, maxWidth / img.width);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });
    };

    // --- RULES ---
    const ValidationService = {
      isMeasureSuspicious: (v, isMonobloc) => {
          if (isMonobloc) return false;
          return v !== undefined && v > 0 && v < 300;
      },
      hasAdvancedOptions: (t) => ['FENETRE', 'VOLET_ROULANT', 'PORTE_ENTREE'].includes(t),
      validateProduct: (p) => {
        const err = [];
        if (p.type !== 'AUTRE') { 
          if (!p.largeurMm) err.push("largeurMm"); 
          if (!p.hauteurMm && !p.monobloc) err.push("hauteurMm"); 
        } else { 
          if (!p.description) err.push("description"); 
        }
        if (['FENETRE', 'BAIE_COULISSANTE', 'PORTE_ENTREE', 'PORTE_SERVICE'].includes(p.type)) {
          if (!p.matiere) err.push("matiere"); 
          if (!p.profil) err.push("profil"); 
          if (!p.couleur) err.push("couleur");
          if (p.couleur === 'AUTRE' && !p.couleurAutre) err.push("couleurAutre"); 
          if (p.profil === 'ISO' && !p.isoMm) err.push("isoMm");
          if (['FENETRE', 'BAIE_COULISSANTE'].includes(p.type)) {
             const v = p.vitrageFlags || {};
             if (!Object.values(v).some(val => val === true)) err.push("vitrageFlags");
          }
          if (p.type === 'PORTE_ENTREE') { 
            if (!p.remplissage) err.push("remplissage"); 
          }
        }
        if (p.type === 'VOLET_ROULANT') {
          if (!p.manoeuvre) err.push("manoeuvre"); 
          if ((p.manoeuvre === 'FILAIRE' || p.manoeuvre === 'RADIO') && !p.sortieCable && p.manoeuvre !== 'SOLAIRE') err.push("sortieCable");
          if (p.monobloc && !p.coffreADeduireMm) err.push("coffreADeduireMm");
        }
        return { isValid: err.length === 0, errors: err };
      }
    };

    const generateSVG = (d) => {
        if (!d || !d.lines || d.lines.length === 0) return '';
        let p = ''; d.lines.forEach(l => { if (l.length < 2) return; let s = `M ${l[0].x} ${l[0].y}`; for (let i = 1; i < l.length; i++) s += ` L ${l[i].x} ${l[i].y}`; p += `<path d="${s}" stroke="#2563EB" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`; });
        return `<svg width="100%" height="100%" viewBox="0 0 350 250" preserveAspectRatio="xMidYMid meet">${p}</svg>`;
    };

    const generateReportHTML = (c, products, dateIso) => {
      const dateObj = new Date(dateIso);
      const formattedDate = dateObj.toLocaleDateString('fr-FR');
      const formattedTime = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

      const styles = `
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @page { margin: 15mm; }
        body { font-family: 'Inter', sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; color: #1e293b; line-height: 1.4; }
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid #2563EB; padding-bottom: 20px; margin-bottom: 30px; }
        .client-box { background: #f8fafc; padding: 20px; border-radius: 8px; flex: 1; margin-right: 20px; border: 1px solid #e2e8f0; }
        .meta-box { flex: 0 0 300px; text-align: right; }
        .stat-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; margin-bottom: 5px; }
        .product-card { border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; overflow: hidden; page-break-inside: avoid; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .product-header { background: #f1f5f9; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #cbd5e1; font-weight: 700; color: #334155; }
        .product-body { display: grid; grid-template-columns: 60% 40%; }
        .specs { padding: 15px; font-size: 0.9em; }
        .visuals { padding: 15px; background: #fcfcfc; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        table.spec-table { width: 100%; border-collapse: collapse; }
        table.spec-table td { padding: 4px 0; vertical-align: top; }
        .label { color: #64748b; font-weight: 600; width: 140px; }
        .value { color: #0f172a; font-weight: 500; }
        .drawing-container { border: 1px dashed #cbd5e1; width: 100%; height: 160px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border-radius: 4px; }
        .photo-row { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        .photo-img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        .alert-text { color: #d97706; font-weight: bold; }
        .notes-box { margin-top: 10px; padding: 10px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 4px; color: #92400e; font-style: italic; }
        @media print { body { padding: 0; margin: 0; } }
      `;
      
      let h = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Relev√© ${c.client}</title><style>${styles}</style></head>
        <body onload="window.print()">
          <div class="header">
            <div class="client-box">
              <h1 style="margin:0 0 10px 0; color:#2563EB;">${c.client}</h1>
              <div>üìç ${c.adresse}</div>
              <div>üìû ${c.telephone} ${c.email ? ` ‚Ä¢ ‚úâÔ∏è ${c.email}` : ''}</div>
            </div>
            <div class="meta-box">
              <div class="stat-badge" style="background:${c.typeContrat === 'FOURNITURE_ET_POSE' ? '#dcfce7;color:#166534' : '#dbeafe;color:#1e40af'}">
                ${c.typeContrat === 'FOURNITURE_ET_POSE' ? 'FOURNITURE ET POSE' : 'FOURNITURE SEULE'}
              </div><br>
              <strong>Date:</strong> ${formattedDate} √† ${formattedTime}<br>
              <strong>Produits:</strong> ${products.reduce((a, b) => a + (b.quantity || 1), 0)}<br>
            </div>
          </div>`;

      products.forEach(p => {
        let r = '';
        const add = (l, v) => { if(v!==undefined&&v!==null&&v!==false&&v!=='') r+=`<tr><td class="label">${l}</td><td class="value">${v===true?'OUI':v}</td></tr>`; };
        
        if(p.room) add('Localisation', `<strong>${p.room}</strong>`);
        add('Quantit√©', `<strong>x ${p.quantity||1}</strong>`);
        
        let dim = `<strong>L ${p.largeurMm} x H ${p.hauteurMm} mm</strong>`;
        if(p.monobloc && p.coffreADeduireMm && p.hauteurMm) dim += `<br><span style="font-size:0.9em;color:#64748b">Passage = <strong>${p.hauteurMm - p.coffreADeduireMm} mm</strong> (Coffre ${p.coffreADeduireMm})</span>`;
        add('Dimensions', dim);

        if(ValidationService.isMeasureSuspicious(p.largeurMm, p.monobloc)||ValidationService.isMeasureSuspicious(p.hauteurMm, p.monobloc)) r+=`<tr><td class="label">‚ö†Ô∏è Attention</td><td class="value alert-text">Cote < 300mm</td></tr>`;

        if(['FENETRE','BAIE_COULISSANTE','PORTE_ENTREE','PORTE_SERVICE'].includes(p.type)) {
          add('Mati√®re',p.matiere); add('Profil',`${p.profil} ${p.profil==='ISO'?`(${p.isoMm}mm)`:''}`); add('Couleur',`${p.couleur} ${p.couleurAutre||''}`);
          if(p.vitrageFlags) { const v=p.vitrageFlags; let va=[]; if(v.standard)va.push('4/20/4'); if(v.g200)va.push('G200'); if(v.feuillete1f)va.push('SP10 (1F)'); if(v.feuillete2f)va.push('SP10 (2F)'); if(va.length)add('Vitrage',va.join(', ')); }
          
          if(p.type==='FENETRE'){ 
              add('Oscillo-Battant',p.oscilloBattant); 
              add('Grille Vent.',p.grilleVentilation); 
              if(p.poigneeHauteur === 'AUTRE' && p.poigneeHauteurMm) add('Hauteur Poign√©e', `${p.poigneeHauteurMm} mm`);
              add('Serrure Cl√©',p.serrureCle); add('Ouv. Ext.',p.ouvertureExterieure); 
          }
          if(p.type==='PORTE_ENTREE'){ 
              add('Remplissage',p.remplissage === 'PANNEAU_DECORATIF_ALU' ? 'Panneau D√©co Alu' : p.remplissage); 
              add('Seuil PMR','OUI'); 
              if(p.tierceImposte)add('Tierce/Imposte','OUI');
              if(p.tierce)add('Tierce',`Passage: ${p.cotePassageMm}mm`); 
              add('Ouv. Ext.',p.ouvertureExterieure); 
          }
          if(p.type==='PORTE_SERVICE') add('Seuil PMR','OUI');
        }
        if(p.type==='VOLET_ROULANT'){ 
            add('Manoeuvre',p.manoeuvre); 
            if(p.sortieCable)add('Sortie C√¢ble',p.sortieCable); 
            if(p.manoeuvre !== 'FILAIRE' && p.boxDomotique) add('Box Domo','OUI'); 
            if(p.coupleMoteur) add('Couple',`${p.coupleMoteur}Nm`);
            if(p.pose) add('Pose',p.pose);
            if(p.monobloc)add('Monobloc',`OUI (Coffre: ${p.coffreADeduireMm}mm)`); 
            if(p.lieAProduitId)add('Li√© √†',`#${products.find(x=>x.id===p.lieAProduitId)?.index || '?'}`); 
        }
        if(p.type==='AUTRE') add('Description',p.description);

        const drawing = p.dessin && p.dessin.lines.length > 0 ? `<div class="drawing-container">${generateSVG(p.dessin)}</div>` : '';
        const imgs = p.photos && p.photos.length > 0 ? `<div class="photo-row">${p.photos.map(src=>`<img src="${src}" class="photo-img"/>`).join('')}</div>` : '';
        const notes = p.notes ? `<div class="notes-box">Note: ${p.notes}</div>` : '';

        h += `<div class="product-card" style="${!p.isValid ? 'border-color:#ef4444; border-width:2px;' : ''}">
            <div class="product-header">
              <span>#${String(p.index).padStart(2,'0')} - ${p.type}</span>
              ${!p.isValid ? '<span style="color:#ef4444">‚ö†Ô∏è INCOMPLET</span>' : ''}
            </div>
            <div class="product-body">
              <div class="specs"><table class="spec-table">${r}</table>${notes}</div>
              <div class="visuals">${drawing}${imgs}</div>
            </div></div>`;
      });
      h += `</body></html>`;
      return h;
    };

    // --- COMPONENTS ---
    const Button = ({ onClick, variant = 'primary', children, icon: Icon, disabled = false, className = '', type="button" }) => {
      const vars = {
        primary: "bg-brand-600 text-white hover:bg-brand-700 disabled:bg-brand-300 shadow-md shadow-brand-500/20",
        whatsapp: "bg-green-600 text-white hover:bg-green-700 shadow-md",
        secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-700",
        danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 dark:bg-red-900/20 dark:border-red-900/30",
        ghost: "text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800"
      };
      return (
        <button type={type} onClick={onClick} disabled={disabled} className={`flex items-center justify-center px-4 py-3 rounded-lg font-medium transition-all active:scale-95 ${vars[variant]} ${className}`}>
          {Icon && <Icon size={18} className="mr-2" />}
          {children}
        </button>
      );
    };

    const Input = ({ label, value, onChange, placeholder, type="text", error, inputMode, pattern, id }) => (
      <div className="mb-4" id={id}>
        {label && <label className={`block text-sm font-medium mb-1.5 ${error ? 'text-red-600' : 'text-slate-700 dark:text-slate-300'}`}>{label} {error && '*'}</label>}
        <input 
          type={type} 
          value={value||''} 
          onChange={e => onChange(e.target.value)} 
          placeholder={placeholder} 
          inputMode={inputMode}
          pattern={pattern}
          className={`w-full p-3 rounded-lg bg-white dark:bg-slate-900 border ${error ? 'border-red-500 focus:ring-red-500' : 'border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-1 focus:ring-brand-500'} outline-none transition-all dark:text-white`}
        />
        {error && <span className="text-xs text-red-500 mt-1">Requis</span>}
      </div>
    );

    const SelectToggle = ({ options, value, onChange, label, error, id }) => (
      <div className="mb-4" id={id}>
        <label className={`block text-sm font-medium mb-2 ${error ? 'text-red-600' : 'text-slate-700 dark:text-slate-300'}`}>{label} {error && '*'}</label>
        <div className={`flex flex-wrap gap-2 p-1 rounded-lg ${error ? 'border border-red-200 bg-red-50' : ''}`}>
          {options.map(opt => {
            const isActive = value === opt.value;
            return (
              <button key={opt.value} onClick={() => onChange(opt.value)} className={`px-3 py-2 rounded-md text-sm font-medium border transition-all ${isActive ? 'bg-brand-600 text-white border-brand-600 shadow-sm' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700'}`}>{opt.label}</button>
            )
          })}
        </div>
      </div>
    );

    const AddressInput = ({ value, onChange }) => {
      const [sug, setSug] = useState([]); 
      const [open, setOpen] = useState(false); 
      const ref = useRef(null);
      const debouncer = useRef(null);
      useEffect(() => { 
        const h = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); }; 
        document.addEventListener("mousedown", h); 
        return () => document.removeEventListener("mousedown", h); 
      }, []);
      const fetchAddress = async (q) => {
        try { const r = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&limit=5`); if(r.ok){ const d = await r.json(); setSug(d.features||[]); setOpen(true); } } catch (err) {}
      };
      const handle = (e) => { 
        const v = e.target.value; onChange(v); 
        if(debouncer.current) clearTimeout(debouncer.current);
        if (v.length > 3) { debouncer.current = setTimeout(() => fetchAddress(v), 300); } else setOpen(false); 
      };
      const geo = () => { if(navigator.geolocation) navigator.geolocation.getCurrentPosition(async p => { try { const r = await fetch(`https://api-adresse.data.gouv.fr/reverse/?lon=${p.coords.longitude}&lat=${p.coords.latitude}`); const d = await r.json(); if(d.features?.length) onChange(d.features[0].properties.label); } catch(e){} }); };

      return (
        <div className="relative mb-4" ref={ref}>
          <label className="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Adresse du chantier</label>
          <div className="relative">
            <input className="w-full p-3 pl-10 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 dark:bg-slate-900 dark:text-white transition-colors" placeholder="Entrez l'adresse..." value={value} onChange={handle}/>
            <MapPin size={18} className="absolute left-3 top-3.5 text-slate-400"/>
            <button onClick={geo} className="absolute right-2 top-2 p-1.5 text-brand-600 hover:bg-brand-50 rounded"><MapPin size={18}/></button>
          </div>
          {open && sug.length > 0 && (<ul className="suggestions-list">{sug.map(s => (<li key={s.properties.id} onClick={() => { onChange(s.properties.label); setOpen(false); }} className="p-3 border-b dark:border-slate-700 hover:bg-brand-50 dark:hover:bg-slate-800 cursor-pointer flex flex-col group"><span className="font-medium text-sm text-slate-800 dark:text-slate-200 group-hover:text-brand-700">{s.properties.name}</span><span className="text-xs text-slate-500">{s.properties.postcode} {s.properties.city}</span></li>))}</ul>)}
        </div>
      );
    };

    // --- FULL SCREEN CAPABLE DRAWING CANVAS ---
    const DrawingCanvas = ({ data, onChange }) => {
      const ref = useRef(null); 
      const fsRef = useRef(null);
      const [lines, setLines] = useState(data?.lines || []); 
      const [isDrawing, setIsDrawing] = useState(false);
      const [isFS, setIsFS] = useState(false);

      // Constants used for internal logic (matches svg viewBox)
      const BASE_W = 350;
      const BASE_H = 250;

      useEffect(() => { onChange({lines, width: BASE_W, height: BASE_H}); }, [lines]);

      const render = (canvas, scale = 1, offX = 0, offY = 0) => {
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        
        ctx.save();
        ctx.translate(offX, offY);
        ctx.scale(scale, scale);
        
        // Draw background white rect so it looks like paper
        ctx.fillStyle = "white";
        ctx.fillRect(0,0,BASE_W,BASE_H);
        
        ctx.lineCap='round'; 
        ctx.lineJoin='round'; 
        ctx.lineWidth=3; // Thick lines for better visibility
        ctx.strokeStyle='#2563EB'; 
        
        lines.forEach(l=>{ 
            if(l.length<1)return; 
            ctx.beginPath(); 
            ctx.moveTo(l[0].x, l[0].y); 
            for(let i=1;i<l.length;i++) ctx.lineTo(l[i].x,l[i].y); 
            ctx.stroke(); 
        });
        ctx.restore();
      };

      // Draw small canvas
      useEffect(() => { render(ref.current); }, [lines]);

      // Draw FS canvas
      const [fsLayout, setFsLayout] = useState({scale: 1, offX: 0, offY: 0});
      useEffect(() => {
         if(!isFS || !fsRef.current) return;
         const cvs = fsRef.current;
         cvs.width = window.innerWidth;
         cvs.height = window.innerHeight;
         
         const sX = cvs.width / BASE_W;
         const sY = cvs.height / BASE_H;
         const scale = Math.min(sX, sY) * 0.95; // Maximize
         const offX = (cvs.width - BASE_W * scale) / 2;
         const offY = (cvs.height - BASE_H * scale) / 2;
         
         setFsLayout({scale, offX, offY});
         render(cvs, scale, offX, offY);
      }, [isFS, lines]);

      // Handlers
      const getPos = (e, cvs, scale=1, offX=0, offY=0) => {
         const r = cvs.getBoundingClientRect();
         const t = e.touches ? e.touches[0] : e;
         // Un-project screen coordinates back to base 350x250
         return { x: (t.clientX - r.left - offX) / scale, y: (t.clientY - r.top - offY) / scale };
      };

      const start = (e, mode) => {
         if(e.cancelable) e.preventDefault();
         setIsDrawing(true);
         const cvs = mode === 'fs' ? fsRef.current : ref.current;
         const {scale, offX, offY} = mode === 'fs' ? fsLayout : {scale:1, offX:0, offY:0};
         setLines(prev => [...prev, [getPos(e, cvs, scale, offX, offY)]]);
      };

      const move = (e, mode) => {
         if(!isDrawing) return;
         if(e.cancelable) e.preventDefault();
         const cvs = mode === 'fs' ? fsRef.current : ref.current;
         const {scale, offX, offY} = mode === 'fs' ? fsLayout : {scale:1, offX:0, offY:0};
         const p = getPos(e, cvs, scale, offX, offY);
         setLines(prev => { const n = [...prev]; n[n.length - 1] = [...n[n.length - 1], p]; return n; });
      };

      return (
        <>
          <div className="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 relative group">
            <div className="flex justify-between mb-2 text-xs text-slate-500 uppercase font-bold tracking-wide">
              <span className="flex items-center"><PenTool size={14} className="mr-1"/> Croquis</span>
              <div className="flex gap-2">
                <button onClick={()=>setLines(p=>p.slice(0,-1))} className="hover:text-brand-600">Annuler</button>
                <button onClick={()=>confirm("Effacer ?")&&setLines([])} className="text-red-500 hover:text-red-700">Effacer</button>
              </div>
            </div>
            <div className="relative">
               <canvas ref={ref} width={BASE_W} height={BASE_H} className="w-full h-48 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded cursor-crosshair touch-none shadow-inner" onMouseDown={(e)=>start(e,'sm')} onMouseMove={(e)=>move(e,'sm')} onMouseUp={()=>setIsDrawing(false)} onMouseLeave={()=>setIsDrawing(false)} onTouchStart={(e)=>start(e,'sm')} onTouchMove={(e)=>move(e,'sm')} onTouchEnd={()=>setIsDrawing(false)}/>
               <button onClick={()=>setIsFS(true)} className="absolute top-2 right-2 p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur rounded-full shadow border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300"><Maximize size={20}/></button>
            </div>
          </div>

          {isFS && (
            <div className="fixed inset-0 z-50 bg-slate-950 flex items-center justify-center touch-none">
               <canvas ref={fsRef} className="block cursor-crosshair" onMouseDown={(e)=>start(e,'fs')} onMouseMove={(e)=>move(e,'fs')} onMouseUp={()=>setIsDrawing(false)} onMouseLeave={()=>setIsDrawing(false)} onTouchStart={(e)=>start(e,'fs')} onTouchMove={(e)=>move(e,'fs')} onTouchEnd={()=>setIsDrawing(false)} />
               
               {/* Controls Overlay */}
               <div className="absolute top-4 right-4 flex gap-3">
                  <button onClick={()=>setIsFS(false)} className="p-3 bg-red-600 text-white rounded-full shadow-lg"><X size={24}/></button>
               </div>
               <div className="absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4 bg-slate-800/90 backdrop-blur p-2 rounded-full border border-slate-700">
                  <button onClick={()=>setLines(p=>p.slice(0,-1))} className="px-6 py-2 bg-slate-700 text-white rounded-full font-bold">Annuler</button>
                  <button onClick={()=>confirm("Tout effacer ?")&&setLines([])} className="px-6 py-2 bg-red-900/50 text-red-200 rounded-full font-bold">Effacer</button>
                  <button onClick={()=>setIsFS(false)} className="px-6 py-2 bg-green-600 text-white rounded-full font-bold flex items-center"><Check size={18} className="mr-2"/> OK</button>
               </div>
            </div>
          )}
        </>
      );
    };

    // --- MAIN APP ---
    const App = () => {
      const [state, setState] = useState({ chantiers: [], products: [], currentChantierId: null });
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState('list');
      const [dark, setDark] = useState(false);
      useEffect(() => { const init = async () => { try { const oldData = localStorage.getItem('sarange_db_v3'); let data; if (oldData) { data = JSON.parse(oldData); await Storage.set('sarange_root', data); localStorage.removeItem('sarange_db_v3'); } else { data = await Storage.get('sarange_root'); } if (data) setState(data); } catch (e) { console.error("DB Error", e); } finally { setLoading(false); } }; init(); }, []);
      useEffect(() => { if (!loading) Storage.set('sarange_root', state); }, [state, loading]);
      useEffect(() => { if (dark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }, [dark]);
      const actions = {
        addChantier: c => setState(s => ({ ...s, chantiers: [{ ...c, id: generateUUID() }, ...s.chantiers] })),
        updateChantier: (id, d) => setState(s => ({ ...s, chantiers: s.chantiers.map(x => x.id === id ? { ...x, ...d } : x) })),
        deleteChantier: id => setState(s => ({ ...s, chantiers: s.chantiers.filter(x => x.id !== id), products: s.products.filter(x => x.chantierId !== id) })),
        selectChantier: id => setState(s => ({ ...s, currentChantierId: id })),
        saveProduct: p => setState(s => { const ex = s.products.find(x => x.id === p.id); const newProds = ex ? s.products.map(x => x.id === p.id ? { ...p, dateMaj: new Date().toISOString() } : x) : [...s.products, p]; return { ...s, products: newProds }; }),
        deleteProduct: id => setState(s => ({ ...s, products: s.products.filter(x => x.id !== id) })),
        duplicateChantier: (id) => { const c = state.chantiers.find(x => x.id === id); if(!c) return; const newId = generateUUID(); const newC = { ...c, id: newId, client: c.client + " (Copie)", date: new Date().toISOString(), dateFinalisation: null }; const cProds = state.products.filter(p => p.chantierId === id).map(p => ({ ...p, id: generateUUID(), chantierId: newId })); setState(s => ({ ...s, chantiers: [newC, ...s.chantiers], products: [...s.products, ...cProds] })); }
      };
      if (loading) return null;
      return <AppContext.Provider value={{ state, ...actions }}><div className="min-h-screen flex flex-col safe-pb">{!state.currentChantierId ? <DashboardView onNew={() => setView('new')} viewMode={view} setViewMode={setView} isDark={dark} toggleDark={() => setDark(!dark)} /> : <ChantierDetailView />}</div></AppContext.Provider>;
    };

    const AppContext = createContext(null);
    const useApp = () => useContext(AppContext);

    const DashboardView = ({ onNew, viewMode, setViewMode, isDark, toggleDark }) => {
      const { state, selectChantier, deleteChantier, duplicateChantier } = useApp();
      const [search, setSearch] = useState(''); const [showNewModal, setShowNewModal] = useState(false);
      const filtered = state.chantiers.filter(c => c.client.toLowerCase().includes(search.toLowerCase()) || c.adresse.toLowerCase().includes(search.toLowerCase()));
      return (
        <>
          <header className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-20 px-4 py-3">
            <div className="flex justify-between items-center mb-4 max-w-5xl mx-auto"><div className="flex items-center gap-2"><div className="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold">S</div><h1 className="text-xl font-bold tracking-tight">Sarange<span className="text-brand-600">Pro</span></h1></div><button onClick={toggleDark} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-600 dark:text-slate-300">{isDark ? <Sun size={20} /> : <Moon size={20} />}</button></div>
            <div className="max-w-5xl mx-auto relative"><Search className="absolute left-3 top-3 text-slate-400" size={20} /><input className="w-full pl-10 p-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 dark:text-white transition-all" placeholder="Rechercher un client..." value={search} onChange={e => setSearch(e.target.value)}/></div>
          </header>
          <main className="flex-1 p-4 max-w-5xl mx-auto w-full">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
              <div className="bg-brand-50 dark:bg-brand-900/20 p-4 rounded-xl border border-brand-100 dark:border-brand-900/30"><div className="text-2xl font-bold text-brand-600">{state.chantiers.length}</div><div className="text-xs text-brand-800 dark:text-brand-300 font-medium">Dossiers</div></div>
              <div className="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-100 dark:border-orange-900/30"><div className="text-2xl font-bold text-orange-600">{state.chantiers.filter(c=>!c.dateFinalisation).length}</div><div className="text-xs text-orange-800 dark:text-orange-300 font-medium">En cours</div></div>
            </div>
            <div className="flex justify-between items-center mb-4"><h2 className="font-bold text-slate-700 dark:text-slate-300">Dossiers R√©cents</h2><Button onClick={() => setShowNewModal(true)} icon={Plus} className="py-2 text-sm shadow-sm">Nouveau</Button></div>
            <div className="space-y-3">
              {filtered.map(c => (
                <div key={c.id} onClick={() => selectChantier(c.id)} className="group bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm active:scale-[0.99] transition-all cursor-pointer hover:border-brand-400 dark:hover:border-brand-600 relative overflow-hidden">
                  <div className="flex justify-between items-start"><div><h3 className="font-bold text-lg dark:text-white group-hover:text-brand-600 transition-colors">{c.client}</h3><p className="text-sm text-slate-500 flex items-center mt-1"><MapPin size={14} className="mr-1"/> {c.adresse}</p></div>{c.dateFinalisation ? <CheckCircle size={20} className="text-green-500"/> : <Clock size={20} className="text-orange-400"/>}</div>
                  <div className="mt-4 flex justify-between items-center border-t border-slate-100 dark:border-slate-800 pt-3"><span className="text-xs font-mono text-slate-400">{new Date(c.date).toLocaleDateString()}</span><div className="flex gap-3"><button onClick={(e)=>{e.stopPropagation();duplicateChantier(c.id)}} className="text-slate-400 hover:text-brand-500"><Copy size={18}/></button><button onClick={(e)=>{e.stopPropagation();if(confirm('Supprimer d√©finitivement ?')) deleteChantier(c.id)}} className="text-slate-400 hover:text-red-500"><Trash2 size={18}/></button></div></div>
                </div>
              ))}
              {filtered.length === 0 && (<div className="text-center py-10 text-slate-400"><div className="mb-2">üì≠</div>Aucun dossier trouv√©.</div>)}
            </div>
          </main>
          {showNewModal && <NewChantierModal onClose={() => setShowNewModal(false)} />}
        </>
      );
    };

    const NewChantierModal = ({ onClose }) => {
      const { addChantier } = useApp(); const [f, setF] = useState({ client: '', adresse: '', typeContrat: 'FOURNITURE_SEULE', telephone: '', email: '' });
      const submit = () => { if (!f.client) return alert('Nom client requis'); addChantier({ ...f, date: new Date().toISOString() }); onClose(); };
      return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end md:items-center justify-center p-4 animate-fade-in"><div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl p-6 shadow-2xl"><h2 className="text-xl font-bold mb-6 dark:text-white">Nouveau Dossier</h2><Input label="Nom Client" value={f.client} onChange={v => setF({...f, client: v})} placeholder="Ex: M. Dupont" /><AddressInput value={f.adresse} onChange={v => setF({...f, adresse: v})} /><div className="grid grid-cols-2 gap-4"><Input label="T√©l√©phone" value={f.telephone} onChange={v => setF({...f, telephone: v})} type="tel" inputMode="tel" pattern="[0-9]*" /><Input label="Email" value={f.email} onChange={v => setF({...f, email: v})} type="email" inputMode="email" /></div><SelectToggle label="Type de contrat" value={f.typeContrat} onChange={v => setF({...f, typeContrat: v})} options={[{label: 'Fourniture Seule', value: 'FOURNITURE_SEULE'}, {label: 'Fourniture & Pose', value: 'FOURNITURE_ET_POSE'}]} /><div className="flex gap-3 mt-6"><Button variant="secondary" onClick={onClose} className="flex-1">Annuler</Button><Button onClick={submit} className="flex-1">Cr√©er</Button></div></div></div>
      );
    };

    const ChantierDetailView = () => {
      const { state, selectChantier, deleteProduct, saveProduct, updateChantier } = useApp();
      const [editingProduct, setEditingProduct] = useState(null); const [showFinalize, setShowFinalize] = useState(false);
      const chantier = state.chantiers.find(c => c.id === state.currentChantierId);
      const products = state.products.filter(p => p.chantierId === chantier?.id).sort((a, b) => a.index - b.index);
      const duplicate = (e, p) => { e.stopPropagation(); saveProduct({ ...p, id: generateUUID(), index: products.length + 1, dateCreation: new Date().toISOString() }); };
      if (!chantier) return null;
      if (editingProduct) return <ProductEditor product={editingProduct} onSave={(p) => { saveProduct(p); setEditingProduct(null); }} onCancel={() => setEditingProduct(null)} />;
      const totalItems = products.reduce((acc, p) => acc + (p.quantity || 1), 0);
      return (
        <div className="flex flex-col h-screen bg-slate-50 dark:bg-slate-950">
          <div className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex items-center justify-between sticky top-0 z-10 shadow-sm"><div className="flex items-center flex-1 min-w-0"><button onClick={() => selectChantier(null)} className="mr-3 p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-200"><ArrowLeft size={24} /></button><div className="truncate"><h2 className="font-bold text-lg dark:text-white truncate">{chantier.client}</h2><div className="text-xs text-slate-500 flex items-center gap-2"><span className="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">{totalItems} Produit(s)</span><span>‚Ä¢ {chantier.typeContrat === 'FOURNITURE_ET_POSE' ? 'Pose' : 'Fourn. Seule'}</span></div></div></div><Button onClick={() => setShowFinalize(true)} className="ml-2 px-3 py-2 text-sm shadow-sm" icon={Check}>Finaliser</Button></div>
          <div className="flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full pb-24"><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{products.map(p => (<div key={p.id} onClick={() => setEditingProduct(p)} className={`bg-white dark:bg-slate-900 rounded-xl p-4 shadow-sm border-l-[6px] cursor-pointer hover:shadow-md transition-all relative group ${p.type.includes('FENETRE') ? 'border-l-blue-500' : p.type.includes('PORTE') ? 'border-l-green-500' : 'border-l-orange-500'} border-t border-r border-b border-slate-200 dark:border-slate-800`}><div className="flex justify-between items-start mb-2"><span className="font-bold text-lg dark:text-white">#{String(p.index).padStart(2, '0')}</span>{p.quantity > 1 && <span className="bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-300 text-xs font-bold px-2 py-1 rounded-full">x{p.quantity}</span>}</div><div className="text-slate-800 dark:text-slate-200 font-medium mb-1">{p.type}</div><div className="text-sm text-slate-500 mb-3">{p.largeurMm} x {p.hauteurMm} mm {p.room && `‚Ä¢ ${p.room}`}</div>{!p.isValid && (<div className="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 px-2 py-1 rounded text-xs inline-flex items-center mb-2"><AlertTriangle size={12} className="mr-1" /> Incomplet</div>)}<div className="flex justify-end gap-3 mt-2 pt-3 border-t border-slate-100 dark:border-slate-800"><button onClick={(e) => duplicate(e, p)} className="text-slate-400 hover:text-brand-600 p-1"><Copy size={18}/></button><button onClick={(e) => { e.stopPropagation(); if (confirm('Supprimer ?')) deleteProduct(p.id); }} className="text-slate-400 hover:text-red-600 p-1"><Trash2 size={18}/></button></div></div>))}<button onClick={() => setEditingProduct({ id: generateUUID(), chantierId: chantier.id, index: products.length + 1, type: 'FENETRE', quantity: 1, dateCreation: new Date().toISOString(), photos: [], isValid: false, validationErrors: [] })} className="min-h-[160px] border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 hover:border-brand-400 transition-colors"><div className="bg-slate-100 dark:bg-slate-800 p-4 rounded-full mb-2"><Plus size={24}/></div><span className="font-medium">Ajouter un produit</span></button></div></div>
          {showFinalize && <FinalizeModal chantier={chantier} products={products} onClose={() => setShowFinalize(false)} onUpdate={(d) => updateChantier(chantier.id, d)} />}
        </div>
      );
    };

    const ProductEditor = ({ product: initial, onSave, onCancel }) => {
      const [p, setP] = useState(initial); const [errors, setErrors] = useState([]); const [adv, setAdv] = useState(false); const fileInputRef = useRef(null); const { state } = useApp();
      const update = (k, v) => setP(pr => ({ ...pr, [k]: v }));
      const updateNested = (parent, k, v) => setP(pr => ({ ...pr, [parent]: { ...(pr[parent] || {}), [k]: v } }));
      const handleSave = () => { const check = ValidationService.validateProduct(p); if (!check.isValid) { setErrors(check.errors); setTimeout(() => { const el = document.getElementById(`field-${check.errors[0]}`); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100); return; } onSave({ ...p, isValid: true, validationErrors: [] }); };
      const handlePhoto = async (e) => { if (e.target.files && e.target.files[0]) { const compressed = await compressImage(e.target.files[0]); update('photos', [...(p.photos || []), compressed]); } };
      const isErr = (field) => errors.includes(field);

      return (
        <div className="fixed inset-0 bg-slate-50 dark:bg-slate-950 z-50 flex flex-col h-full animate-fade-in">
          <div className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex justify-between items-center shadow-sm shrink-0"><button onClick={onCancel} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><X size={24} className="text-slate-500"/></button><h2 className="font-bold dark:text-white">Produit #{String(p.index).padStart(2,'0')}</h2><Button onClick={handleSave} className="px-5 py-2 rounded-full" icon={Save}>Sauver</Button></div>
          <div className="flex-1 overflow-y-auto p-4 pb-20 max-w-3xl mx-auto w-full">
            {errors.length > 0 && (<div className="mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900/50 text-red-700 dark:text-red-300 p-3 rounded-lg flex items-center"><AlertCircle size={20} className="mr-2"/><span>Des champs obligatoires sont manquants.</span></div>)}
            <div className="space-y-4">
              <div className="bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800">
                <SelectToggle label="Type de produit" value={p.type} onChange={v => update('type', v)} options={[{label:'Fen√™tre', value:'FENETRE'}, {label:'Baie', value:'BAIE_COULISSANTE'}, {label:'Porte Entr√©e', value:'PORTE_ENTREE'}, {label:'Porte Service', value:'PORTE_SERVICE'}, {label:'Volet', value:'VOLET_ROULANT'}, {label:'Autre', value:'AUTRE'}]} />
                <div className="flex items-center justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-lg mb-4 border border-slate-100 dark:border-slate-700"><span className="font-medium text-slate-700 dark:text-slate-300">Quantit√©</span><div className="flex items-center gap-4"><button className="w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold" onClick={() => update('quantity', Math.max(1, (p.quantity || 1) - 1))}>-</button><span className="font-bold text-xl w-6 text-center dark:text-white">{p.quantity || 1}</span><button className="w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold" onClick={() => update('quantity', (p.quantity || 1) + 1)}>+</button></div></div>
                <Input label="Localisation (Pi√®ce)" value={p.room} onChange={v => update('room', v)} placeholder="Ex: Cuisine, Salon..." />
                {p.type==='AUTRE' && <Input id="field-description" label="Description" value={p.description} onChange={v => update('description', v)} error={isErr('description')}/>}
                <div className="grid grid-cols-2 gap-4"><Input id="field-largeurMm" label="Largeur (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.largeurMm} onChange={v => update('largeurMm', parseInt(v))} error={isErr('largeurMm')} /><Input id="field-hauteurMm" label="Hauteur (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.hauteurMm} onChange={v => update('hauteurMm', parseInt(v))} error={isErr('hauteurMm')} /></div>
                {ValidationService.isMeasureSuspicious(p.largeurMm, p.monobloc) || ValidationService.isMeasureSuspicious(p.hauteurMm, p.monobloc) ? (<div className="text-orange-500 text-xs flex items-center mt-[-10px] mb-4"><AlertTriangle size={12} className="mr-1"/> Attention: Cotes tr√®s petites (&lt;150mm)</div>) : null}
              </div>

              {['FENETRE','BAIE_COULISSANTE','PORTE_ENTREE','PORTE_SERVICE'].includes(p.type) && (
                <div className="bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800">
                  <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Caract√©ristiques</h3>
                  <SelectToggle id="field-matiere" label="Mati√®re" value={p.matiere} onChange={v => update('matiere', v)} error={isErr('matiere')} options={[{label:'PVC', value:'PVC'}, {label:'Alu', value:'ALU'}]} />
                  {p.matiere && <SelectToggle id="field-profil" label="Type de Pose (Profil)" value={p.profil} onChange={v => update('profil', v)} error={isErr('profil')} options={p.matiere === 'PVC' ? [{label:'Neuf', value:'NEUF'}, {label:'R√©nov 40', value:'RENO_40'}, {label:'R√©nov 60', value:'RENO_60'}, {label:'ISO', value:'ISO'}] : [{label:'Neuf', value:'NEUF'}, {label:'R√©nov', value:'RENO'}]} />}
                  {p.profil === 'ISO' && <Input id="field-isoMm" label="Aile ISO (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.isoMm} onChange={v => update('isoMm', parseInt(v))} error={isErr('isoMm')} />}
                  <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                    <SelectToggle id="field-couleur" label="Couleur" value={p.couleur} onChange={v => update('couleur', v)} error={isErr('couleur')} options={p.matiere==='PVC' ? [{label:'Blanc',value:'BLANC'},{label:'Bicolor 7016',value:'BICOLOR_7016'},{label:'Autre',value:'AUTRE'}] : [{label:'Blanc',value:'BLANC'},{label:'Gris 7016',value:'GRIS_7016'},{label:'Autre',value:'AUTRE'}]} />
                    {p.couleur === 'AUTRE' && <Input id="field-couleurAutre" placeholder="Pr√©ciser couleur (ex: ch√™ne dor√©)" value={p.couleurAutre} onChange={v => update('couleurAutre', v)} error={isErr('couleurAutre')} />}
                  </div>
                </div>
              )}

              {/* OPTIONS COURANTES EXPLICITES */}
              {p.type === 'FENETRE' && (
                <div className="bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4">
                  <h3 className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Options Courantes</h3>
                  <div className="flex items-center gap-4">
                    <label className="flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700">
                      <span className="dark:text-white font-medium text-sm">Oscillo-Battant</span>
                      <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.oscilloBattant} onChange={e=>update('oscilloBattant', e.target.checked)} disabled={p.hauteurMm > 2200}/>
                    </label>
                    <label className="flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700">
                      <span className="dark:text-white font-medium text-sm">Grille Ventil.</span>
                      <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.grilleVentilation} onChange={e=>update('grilleVentilation', e.target.checked)}/>
                    </label>
                  </div>
                  <div className="pt-2">
                    <label className="text-sm dark:text-slate-300 font-medium mb-2 block">Hauteur Poign√©e</label>
                    <div className="flex gap-2">
                      <button onClick={()=>update('poigneeHauteur','CENTREE')} className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${p.poigneeHauteur!=='AUTRE' ? 'bg-brand-600 text-white border-brand-600' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700'}`}>Centr√©e</button>
                      <button onClick={()=>update('poigneeHauteur','AUTRE')} className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${p.poigneeHauteur==='AUTRE' ? 'bg-brand-600 text-white border-brand-600' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700'}`}>Autre</button>
                    </div>
                    {p.poigneeHauteur==='AUTRE'&&<input type="number" inputMode="numeric" pattern="[0-9]*" className="mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700" placeholder="Hauteur en mm" value={p.poigneeHauteurMm||''} onChange={e=>update('poigneeHauteurMm',parseInt(e.target.value))}/>}
                  </div>
                </div>
              )}

              {(p.type === 'FENETRE' || p.type === 'BAIE_COULISSANTE') && (
                <div id="field-vitrageFlags" className={`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border ${isErr('vitrageFlags') ? 'border-red-500 ring-1 ring-red-500' : 'border-slate-200 dark:border-slate-800'}`}>
                  <h3 className={`text-xs font-bold uppercase mb-3 tracking-wider ${isErr('vitrageFlags') ? 'text-red-500' : 'text-slate-400'}`}>Vitrage {isErr('vitrageFlags') && '*'}</h3>
                  <div className="grid grid-cols-2 gap-3">{[['standard','Standard 4/20/4'], ['g200','G200 (Imprim√©)'], ['feuillete1f','SP10 1 Face'], ['feuillete2f','SP10 2 Faces']].map(([k, label]) => (<label key={k} className={`flex items-center p-3 rounded-lg border cursor-pointer transition-all ${p.vitrageFlags?.[k] ? 'bg-brand-50 border-brand-500 text-brand-700 dark:bg-brand-900/30' : 'border-slate-200 dark:border-slate-700 dark:text-white'}`}><input type="checkbox" className="w-5 h-5 rounded text-brand-600 focus:ring-brand-500" checked={!!p.vitrageFlags?.[k]} onChange={e => updateNested('vitrageFlags', k, e.target.checked)} /><span className="ml-2 text-sm font-medium">{label}</span></label>))}</div>
                </div>
              )}

              {p.type === 'VOLET_ROULANT' && (
                <div className="bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800">
                  <div className="mb-4"><label className="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Lier √† une menuiserie</label><select className="w-full p-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 dark:text-white" value={p.lieAProduitId||''} onChange={e=>update('lieAProduitId',e.target.value)}><option value="">-- Ind√©pendant --</option>{state.products.filter(x=>['FENETRE','BAIE_COULISSANTE'].includes(x.type)).map(x=><option key={x.id} value={x.id}>#{x.index} {x.type}</option>)}</select></div>
                  <SelectToggle id="field-manoeuvre" label="Manoeuvre" value={p.manoeuvre} onChange={v => update('manoeuvre', v)} error={isErr('manoeuvre')} options={[{label:'Filaire',value:'FILAIRE'},{label:'Radio',value:'RADIO'},{label:'Solaire',value:'SOLAIRE'}]} />
                  {p.manoeuvre && p.manoeuvre !== 'SOLAIRE' && (<SelectToggle id="field-sortieCable" label="Sortie C√¢ble (Vue Int.)" value={p.sortieCable} onChange={v => update('sortieCable', v)} error={isErr('sortieCable')} options={[{label:'Gauche',value:'GAUCHE'},{label:'Droite',value:'DROITE'}]} />)}
                  {p.manoeuvre !== 'FILAIRE' && <label className="flex items-center p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 mt-4 mb-4"><input type="checkbox" className="w-5 h-5 accent-brand-600" checked={!!p.boxDomotique} onChange={e=>update('boxDomotique',e.target.checked)}/><span className="ml-3 font-medium dark:text-white">Box Domotique</span></label>}
                  <div className="my-4" id="field-coffreADeduireMm"><label className="flex items-center justify-between p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700"><span className="font-medium dark:text-white">Volet Monobloc ?</span><input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.monobloc} onChange={e => update('monobloc', e.target.checked)} /></label>{p.monobloc && (<div className="mt-3 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg"><Input label="Hauteur Coffre √† d√©duire" type="number" inputMode="numeric" pattern="[0-9]*" value={p.coffreADeduireMm} onChange={v => update('coffreADeduireMm', parseInt(v))} error={isErr('coffreADeduireMm')} /><div className="text-right text-sm font-bold text-brand-600">Hauteur Passage: {p.hauteurMm && p.coffreADeduireMm ? p.hauteurMm - p.coffreADeduireMm : '-'} mm</div></div>)}</div>
                </div>
              )}

              {ValidationService.hasAdvancedOptions(p.type) && (
                <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden">
                  <button onClick={() => setAdv(!adv)} className="w-full flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800/50 font-medium text-slate-700 dark:text-slate-300"><span>Options Avanc√©es</span>{adv ? <ChevronUp size={18}/> : <ChevronDown size={18}/>}</button>
                  {adv && (
                    <div className="p-4 border-t border-slate-200 dark:border-slate-800 space-y-4">
                      {(p.type.includes('FENETRE') || p.type.includes('PORTE')) && (
                        <div className="space-y-3">
                          <label className="flex items-center justify-between"><span className="dark:text-white">Ouverture Ext√©rieure</span> <input type="checkbox" className="w-5 h-5 accent-brand-600" checked={!!p.ouvertureExterieure} onChange={e=>update('ouvertureExterieure', e.target.checked)}/></label>
                          {p.type !== 'PORTE_ENTREE' && <label className="flex items-center justify-between"><span className="dark:text-white">Serrure √† cl√©</span> <input type="checkbox" className="w-5 h-5 accent-brand-600" checked={!!p.serrureCle} onChange={e=>update('serrureCle', e.target.checked)}/></label>}
                          {p.type === 'PORTE_ENTREE' && <label className="flex items-center justify-between"><span className="dark:text-white font-bold">Tierce / Imposte ?</span> <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.tierceImposte} onChange={e=>update('tierceImposte', e.target.checked)}/></label>}
                        </div>
                      )}
                      {p.type === 'VOLET_ROULANT' && (<div><SelectToggle label="Couple Moteur" value={p.coupleMoteur || 10} onChange={v=>update('coupleMoteur', v)} options={[{label:'10 Nm', value:10}, {label:'20 Nm', value:20}]}/><SelectToggle label="Type Pose VR" value={p.pose || 'RENO'} onChange={v=>update('pose', v)} options={[{label:'R√©nov', value:'RENO'}, {label:'Tradi', value:'TRADI'}, {label:'Tunnel', value:'TUNNEL'}]}/></div>)}
                    </div>
                  )}
                </div>
              )}

              {p.type==='PORTE_ENTREE'&& (
                <div className="bg-white dark:bg-slate-900 p-5 rounded-xl border dark:border-slate-800">
                  <SelectToggle id="field-remplissage" label="Remplissage" value={p.remplissage} onChange={v=>update('remplissage',v)} error={isErr('remplissage')} options={[{label:'Panneau D√©co Alu',value:'PANNEAU_DECORATIF_ALU'},{label:'Sandwich',value:'PANNEAU_SANDWICH'},{label:'Vitr√©e',value:'VITREE'}]}/>
                  {p.largeurMm>1000 && (
                    <div className="mt-3 pt-3 border-t dark:border-slate-700">
                      <label className="flex items-center justify-between mb-3"><span className="dark:text-white font-medium">Tierce ?</span> <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.tierce} onChange={e=>update('tierce',e.target.checked)}/></label>
                      {p.tierce&&<Input id="field-cotePassageMm" label="Cote Passage (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.cotePassageMm} onChange={v=>update('cotePassageMm',v)} error={isErr('cotePassageMm')} />}
                    </div>
                  )}
                </div>
              )}

              <DrawingCanvas data={p.dessin} onChange={d => update('dessin', d)} />
              
              <div className="bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800">
                <div className="mb-4"><label className="block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300">Photos</label><div className="grid grid-cols-4 gap-2">{(p.photos || []).map((src, i) => (<div key={i} className="relative aspect-square rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 group"><img src={src} className="w-full h-full object-cover" /><button onClick={() => update('photos', p.photos.filter((_, idx) => idx !== i))} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md opacity-80 hover:opacity-100"><X size={12}/></button></div>))}<button onClick={() => fileInputRef.current?.click()} className="aspect-square rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 flex flex-col items-center justify-center text-slate-400 hover:text-brand-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"><Camera size={24} /><span className="text-[10px] mt-1">Ajouter</span></button><input type="file" ref={fileInputRef} accept="image/*" className="hidden" onChange={handlePhoto} /></div></div>
                <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Notes techniques</label><textarea className="w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white h-24 text-sm focus:border-brand-500 outline-none" placeholder="Contraintes de pose, acc√®s..." value={p.notes || ''} onChange={e => update('notes', e.target.value)}/></div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const FinalizeModal = ({ chantier, products, onClose, onUpdate }) => {
      const incomplete = products.filter(p => !p.isValid);
      const prepareFile = () => {
         const date = new Date().toISOString();
         onUpdate({ dateFinalisation: date });
         const html = generateReportHTML(chantier, products, date);
         
         const d = new Date();
         const day = String(d.getDate()).padStart(2, '0');
         const month = String(d.getMonth() + 1).padStart(2, '0');
         const year = d.getFullYear();
         const filenameDate = `${day}-${month}-${year}`;

         return new File([html], `Releve_${chantier.client.replace(/\s+/g,'_')}_${filenameDate}.html`, { type: 'text/html' });
      };
      const share = async () => {
         const file = prepareFile();
         if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try { await navigator.share({ files: [file], title: `Relev√© ${chantier.client}`, text: `Voici le relev√© pour ${chantier.client}` }); } catch (err) { console.log(err); }
         } else { alert("Le partage de fichiers n'est pas support√©. Utilisez l'option Imprimer."); }
      };
      const print = () => {
         const file = prepareFile(); const url = URL.createObjectURL(file); const win = window.open(url, '_blank'); if(!win) alert("Pop-up bloqu√©.");
      };
      return (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl text-center"><div className="mb-4 flex justify-center"><div className={`p-4 rounded-full ${incomplete.length ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'}`}>{incomplete.length ? <AlertTriangle size={32}/> : <CheckCircle size={32}/>}</div></div><h3 className="text-xl font-bold mb-2 dark:text-white">Finaliser le dossier</h3>{incomplete.length > 0 ? (<p className="text-orange-600 mb-6 bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg text-sm">Il reste <strong>{incomplete.length} produits incomplets</strong>. Vous devriez les v√©rifier avant d'exporter.</p>) : (<p className="text-slate-500 mb-6 text-sm">Le dossier est complet.</p>)}<div className="space-y-3"><Button onClick={share} variant="whatsapp" className="w-full" icon={Share}>Partager (WhatsApp/Mail)</Button><Button onClick={print} variant="secondary" className="w-full" icon={Printer}>Imprimer / Sauvegarder PDF</Button><Button onClick={onClose} variant="ghost" className="w-full">Retour</Button></div></div></div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  </script>
</body>
</html>
